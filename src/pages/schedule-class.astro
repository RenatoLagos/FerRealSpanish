---
import Layout from '../layouts/Layout.astro';
import Button from '../components/ui/button.astro';

// reCAPTCHA site key from environment variables
const siteKey = import.meta.env.RECAPTCHA_SITE_KEY || "6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"; // Fallback to test key

// Toggle between booking and waitlist modes
const classesAvailable = import.meta.env.CLASSES_AVAILABLE === 'true';

// Dynamic meta tags based on mode
const pageTitle = classesAvailable
  ? "Schedule Your Spanish Class Online - Free Trial | FerRealSpanish"
  : "Join the Waitlist - Spanish Classes | FerRealSpanish";

const pageDescription = classesAvailable
  ? "Book your personalized Spanish class with native teacher Fernanda. Choose your preferred date and time. First class is FREE! Flexible scheduling and proven teaching methods."
  : "Join our waitlist for personalized Spanish classes with native teacher Fernanda. Be the first to know when new spots open up!";

const pageKeywords = classesAvailable
  ? "schedule spanish class, book spanish lesson, online spanish class booking, spanish teacher appointment, free spanish trial class"
  : "spanish class waitlist, spanish lessons waitlist, online spanish classes, spanish teacher, learn spanish";
---

<Layout
  title={pageTitle}
  description={pageDescription}
  keywords={pageKeywords}
  image="/program-1.webp"
  type="website"
>
  <script src="https://www.google.com/recaptcha/api.js" async defer slot="head"></script>

  {classesAvailable ? (
    <!-- ==================== BOOKING MODE ==================== -->
    <Fragment>
      <!-- Header Banner -->
      <div class="bg-[var(--background-primary)] py-12 pt-48">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
          <h1 class="text-3xl md:text-4xl font-satoshi font-extrabold text-gray-800 mb-4">Schedule Your Class</h1>
          <p class="text-gray-600 text-lg font-satoshi font-semibold max-w-2xl mx-auto">
            Select a date and time that works best for you.
          </p>
        </div>
      </div>

      <!-- Calendar Selection -->
      <div class="py-8 bg-[var(--background-primary)] min-h-screen pb-64">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <!-- Centered Card Layout -->
          <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2">
              <!-- Left Column: Calendar -->
              <div class="p-6 border-r border-gray-200">
                <div id="calendar" class="calendar-container calendar-pulse">
                  <!-- Calendar will be rendered here by the script -->
                </div>
              </div>

              <!-- Right Column: Available Times -->
              <div class="p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Available Time Slots</h3>

                <!-- Selected Date Display -->
                <div id="selectedDate" class="text-sm font-medium mb-4 text-gray-600">
                  Please select a date from the calendar
                </div>

                <!-- Loading indicator -->
                <div id="loading" class="hidden text-center py-4">
                  <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-[#7dd3c0] hover:bg-[#6bc4b1] transition ease-in-out duration-150">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading available times...
                  </div>
                </div>

                <!-- Available Time Slots -->
                <div id="timeSlots" class="space-y-2 mb-6">
                  <div class="p-3 border border-gray-200 rounded-md text-center text-gray-400 text-sm">Select a date to see available times</div>
                </div>

                <!-- Student Information Form -->
                <div id="studentForm" class="hidden space-y-4 mb-6 p-4 bg-gray-50 rounded-md">
                  <h4 class="font-medium text-gray-800">Student Information</h4>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input
                      type="text"
                      id="studentName"
                      required
                      class="w-full p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#7dd3c0]"
                      placeholder="Enter your full name"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input
                      type="email"
                      id="studentEmail"
                      required
                      class="w-full p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#7dd3c0]"
                      placeholder="Enter your email"
                    />
                    <div id="emailError" class="hidden text-red-500 text-xs mt-1"></div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Lesson Type</label>
                    <div class="flex gap-4">
                      <label class="flex items-center cursor-pointer">
                        <input
                          type="radio"
                          name="lessonType"
                          id="lessonTypeIndividual"
                          value="individual"
                          checked
                          class="w-4 h-4 text-[#7dd3c0] focus:ring-[#7dd3c0] focus:ring-2"
                        />
                        <span class="ml-2 text-sm text-gray-700">Individual Lessons</span>
                      </label>
                      <label class="flex items-center cursor-pointer">
                        <input
                          type="radio"
                          name="lessonType"
                          id="lessonTypeGroup"
                          value="group"
                          class="w-4 h-4 text-[#7dd3c0] focus:ring-[#7dd3c0] focus:ring-2"
                        />
                        <span class="ml-2 text-sm text-gray-700">Group Lessons</span>
                      </label>
                    </div>
                    <p id="groupLessonNote" class="text-xs text-gray-500 mt-1 hidden">Group lessons require a minimum of 2 people</p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Spanish Level</label>
                    <select id="spanishLevel" class="w-full p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#7dd3c0]">
                      <option value="beginner">Beginner</option>
                      <option value="elementary">Elementary</option>
                      <option value="intermediate">Intermediate</option>
                      <option value="advanced">Advanced</option>
                    </select>
                  </div>

                  <!-- reCAPTCHA -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Human Verification</label>
                    <div class="g-recaptcha" data-sitekey={siteKey}></div>
                    <div id="captchaError" class="hidden text-red-500 text-xs mt-1"></div>
                  </div>
                </div>

                <!-- Booking Form -->
                <div id="bookingForm" class="space-y-4">
                  <Button
                    variant="primary"
                    size="lg"
                    textSize="sm"
                    fullWidth={true}
                    rounded={true}
                    class="confirm-booking-btn"
                  >
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span id="confirmBooking">Select a time slot</span>
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Success Modal (Booking) -->
      <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
          <div class="p-6 text-center">
            <!-- Success Icon -->
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
              <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>

            <!-- Title -->
            <h3 class="text-xl font-bold text-gray-900 mb-2">Booking Confirmed!</h3>

            <!-- Message -->
            <p class="text-gray-600 mb-6">
              Your class has been successfully scheduled. You will receive a confirmation email shortly with the Google Meet link and class details.
            </p>

            <!-- Class Details -->
            <div id="bookingDetails" class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
              <h4 class="font-semibold text-gray-800 mb-2">Class Details:</h4>
              <div class="space-y-1 text-sm text-gray-600">
                <div id="modalDate"></div>
                <div id="modalTime"></div>
                <div id="modalStudent"></div>
              </div>
            </div>

            <!-- Close Button -->
            <button
              id="closeModal"
              class="w-full bg-[#7dd3c0] hover:bg-[#6bc4b1] text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2"
            >
              <span>Perfect!</span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </Fragment>
  ) : (
    <!-- ==================== WAITLIST MODE ==================== -->
    <Fragment>
      <!-- Header Banner -->
      <div class="bg-[var(--background-primary)] py-12 pt-48">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
          <h1 class="text-3xl md:text-4xl font-satoshi font-extrabold text-gray-800 mb-4">Classes Are Full!</h1>
          <p class="text-gray-600 text-lg font-satoshi font-semibold max-w-2xl mx-auto">
            All spots are currently taken. Join our waitlist to be notified when new spots become available.
          </p>
        </div>
      </div>

      <!-- Waitlist Form Section -->
      <div class="py-8 bg-[var(--background-primary)] min-h-screen pb-64">
        <div class="max-w-xl mx-auto px-4 sm:px-6 lg:px-8">
          <!-- Card Layout -->
          <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-8">
              <!-- Status Badge -->
              <div class="flex justify-center mb-6">
                <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-amber-100 text-amber-800">
                  <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                  </svg>
                  Currently at full capacity
                </span>
              </div>

              <!-- Description -->
              <div class="text-center mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Join the Waitlist</h2>
                <p class="text-gray-600 text-sm">
                  Leave your information below and we'll contact you as soon as a spot opens up. You'll also receive updates about new class schedules and special offers.
                </p>
              </div>

              <!-- Waitlist Form -->
              <form id="waitlistForm" class="space-y-5">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                  <input
                    type="text"
                    id="waitlistName"
                    required
                    class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#7dd3c0] focus:border-transparent"
                    placeholder="Enter your full name"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                  <input
                    type="email"
                    id="waitlistEmail"
                    required
                    class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#7dd3c0] focus:border-transparent"
                    placeholder="Enter your email"
                  />
                  <div id="waitlistEmailError" class="hidden text-red-500 text-xs mt-1"></div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Spanish Level</label>
                  <select id="waitlistLevel" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#7dd3c0] focus:border-transparent">
                    <option value="beginner">Beginner</option>
                    <option value="elementary">Elementary</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Message (Optional)</label>
                  <textarea
                    id="waitlistMessage"
                    rows="3"
                    class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#7dd3c0] focus:border-transparent resize-none"
                    placeholder="Tell us about your goals or preferred schedule..."
                  ></textarea>
                </div>

                <!-- reCAPTCHA -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Human Verification *</label>
                  <div class="g-recaptcha" data-sitekey={siteKey}></div>
                  <div id="waitlistCaptchaError" class="hidden text-red-500 text-xs mt-1"></div>
                </div>

                <!-- Submit Button -->
                <Button
                  variant="primary"
                  size="lg"
                  textSize="sm"
                  fullWidth={true}
                  rounded={true}
                  class="waitlist-submit-btn mt-6"
                  type="submit"
                >
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                  </svg>
                  <span id="waitlistSubmitText">Join the Waitlist</span>
                </Button>
              </form>

              <!-- Privacy Note -->
              <p class="text-xs text-gray-500 text-center mt-6">
                We respect your privacy. Your information will only be used to contact you about class availability.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Success Modal (Waitlist) -->
      <div id="waitlistSuccessModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
          <div class="p-6 text-center">
            <!-- Success Icon -->
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
              <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>

            <!-- Title -->
            <h3 class="text-xl font-bold text-gray-900 mb-2">You're on the Waitlist!</h3>

            <!-- Message -->
            <p class="text-gray-600 mb-6">
              Thanks for your interest! We'll notify you as soon as a spot becomes available. Keep an eye on your inbox for updates and special offers.
            </p>

            <!-- Details -->
            <div id="waitlistDetails" class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
              <h4 class="font-semibold text-gray-800 mb-2">Your Information:</h4>
              <div class="space-y-1 text-sm text-gray-600">
                <div id="waitlistModalName"></div>
                <div id="waitlistModalEmail"></div>
                <div id="waitlistModalLevel"></div>
              </div>
            </div>

            <!-- Close Button -->
            <button
              id="closeWaitlistModal"
              class="w-full bg-[#7dd3c0] hover:bg-[#6bc4b1] text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2"
            >
              <span>Got it!</span>
            </button>
          </div>
        </div>
      </div>
    </Fragment>
  )}
</Layout>

{classesAvailable && (
  <!-- ==================== BOOKING SCRIPT ==================== -->
  <script is:inline>
    // Calendar state variables
    let selectedTimeSlot = null;
    let selectedDate = null;

    const timeFormatter = new Intl.DateTimeFormat(undefined, {
      hour: 'numeric',
      minute: '2-digit'
    });
    const timeFormatterWithZone = new Intl.DateTimeFormat(undefined, {
      hour: 'numeric',
      minute: '2-digit',
      timeZoneName: 'short'
    });

    function formatLocalTimeRange(startISO, endISO) {
      const startDate = new Date(startISO);
      const endDate = new Date(endISO);

      if (Number.isNaN(startDate.getTime()) || Number.isNaN(endDate.getTime())) {
        return '';
      }

      const startLabel = timeFormatter.format(startDate);
      const endLabel = timeFormatter.format(endDate);
      const zonePart = timeFormatterWithZone
        .formatToParts(startDate)
        .find(part => part.type === 'timeZoneName')
        ?.value.trim() ?? '';

      return zonePart ? `${startLabel} - ${endLabel} ${zonePart}` : `${startLabel} - ${endLabel}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Current date
      const currentDate = new Date();

      // Calculate the first available day (tomorrow)
      const tomorrow = new Date();
      tomorrow.setDate(currentDate.getDate() + 1);

      // Initialize calendar in the month of the first available day
      let currentMonth = tomorrow.getMonth();
      let currentYear = tomorrow.getFullYear();

      // Elements
      const calendarEl = document.getElementById('calendar');
      const selectedDateEl = document.getElementById('selectedDate');
      const timeSlotsEl = document.getElementById('timeSlots');
      const loadingEl = document.getElementById('loading');
      const confirmBookingEl = document.getElementById('confirmBooking');
      const studentForm = document.getElementById('studentForm');

      // Initialize calendar and add event listeners
      renderCalendar(currentMonth, currentYear);
      addEventListeners();

      function addEventListeners() {
        // Confirm booking button
        document.querySelector('.confirm-booking-btn')?.addEventListener('click', () => {
          if (selectedTimeSlot && selectedDate) {
            handleBookingConfirmation();
          }
        });

        // Email validation
        document.getElementById('studentEmail')?.addEventListener('blur', validateEmail);

        // Lesson type radio buttons
        const groupLessonNote = document.getElementById('groupLessonNote');
        document.getElementById('lessonTypeIndividual')?.addEventListener('change', () => {
          groupLessonNote?.classList.add('hidden');
        });
        document.getElementById('lessonTypeGroup')?.addEventListener('change', () => {
          groupLessonNote?.classList.remove('hidden');
        });

        // Modal close
        document.getElementById('closeModal')?.addEventListener('click', closeSuccessModal);

        // Close modal when clicking outside
        document.getElementById('successModal')?.addEventListener('click', (e) => {
          if (e.target === e.currentTarget) {
            closeSuccessModal();
          }
        });
      }

      // Validate email format
      function validateEmail() {
        const emailInput = document.getElementById('studentEmail');
        const emailError = document.getElementById('emailError');

        if (!emailInput || !emailError) return true;

        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (email && !emailRegex.test(email)) {
          emailError.textContent = 'Please enter a valid email address';
          emailError.classList.remove('hidden');
          emailInput.classList.add('border-red-300');
          return false;
        } else {
          emailError.classList.add('hidden');
          emailInput.classList.remove('border-red-300');
          return true;
        }
      }

      // Validate reCAPTCHA
      function validateCaptcha() {
        const captchaError = document.getElementById('captchaError');

        if (!captchaError) return false;

        const recaptchaResponse = window.grecaptcha?.getResponse();

        if (!recaptchaResponse || recaptchaResponse.length === 0) {
          captchaError.textContent = 'Please complete the reCAPTCHA verification.';
          captchaError.classList.remove('hidden');
          return false;
        } else {
          captchaError.classList.add('hidden');
          return true;
        }
      }

      // Show success modal
      function showSuccessModal(bookingData) {
        const modal = document.getElementById('successModal');
        const modalDate = document.getElementById('modalDate');
        const modalTime = document.getElementById('modalTime');
        const modalStudent = document.getElementById('modalStudent');

        if (modal && modalDate && modalTime && modalStudent) {
          // Format date
          const [year, month, day] = bookingData.date.split('-');
          const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
          const formattedDate = date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });

          modalDate.textContent = `ðŸ“… ${formattedDate}`;
          modalTime.textContent = `ðŸ• ${bookingData.displayTime}`;
          modalStudent.textContent = `ðŸ‘¤ ${bookingData.studentName}`;

          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
      }

      // Close success modal and redirect to landing page
      function closeSuccessModal() {
        const modal = document.getElementById('successModal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto';
          resetBookingForm();

          // Redirect to landing page after a short delay
          setTimeout(() => {
            window.location.href = '/';
          }, 300);
        }
      }

      // Render calendar
      function renderCalendar(month, year) {
        const monthNames = ["January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"];

        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();

        let calendarHTML = `
          <div class="flex justify-between items-center mb-6">
            <button id="prevMonth" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
              </svg>
            </button>
            <div class="text-lg font-semibold text-gray-800">${monthNames[month]} ${year}</div>
            <button id="nextMonth" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
              </svg>
            </button>
          </div>
        `;

        calendarHTML += `
          <div class="grid grid-cols-7 gap-1 mb-2">
            <div class="text-center text-xs font-medium text-gray-500 py-2">Su</div>
            <div class="text-center text-xs font-medium text-gray-500 py-2">Mo</div>
            <div class="text-center text-xs font-medium text-gray-500 py-2">Tu</div>
            <div class="text-center text-xs font-medium text-gray-500 py-2">We</div>
            <div class="text-center text-xs font-medium text-gray-500 py-2">Th</div>
            <div class="text-center text-xs font-medium text-gray-500 py-2">Fr</div>
            <div class="text-center text-xs font-medium text-gray-500 py-2">Sa</div>
          </div>
        `;

        calendarHTML += '<div class="grid grid-cols-7 gap-1">';

        const today = new Date();
        const todayDate = today.getDate();
        const todayMonth = today.getMonth();
        const todayYear = today.getFullYear();

        for (let i = 0; i < firstDay; i++) {
          calendarHTML += '<div class="h-8 p-1"></div>';
        }

        for (let day = 1; day <= lastDate; day++) {
          const isToday = day === todayDate && month === todayMonth && year === todayYear;
          const isPast = new Date(year, month, day) <= new Date(todayYear, todayMonth, todayDate);
          const dayOfWeek = new Date(year, month, day).getDay();
          const isAllowedDay = [1, 2, 3].includes(dayOfWeek); // Monday, Tuesday, Wednesday only

          if (isPast || isToday) {
            calendarHTML += `<div class="h-8 p-1">
              <div class="h-full flex items-center justify-center text-gray-300 text-sm">${day}</div>
            </div>`;
          } else if (!isAllowedDay) {
            calendarHTML += `<div class="h-8 p-1">
              <div class="h-full flex items-center justify-center text-gray-400 text-sm">${day}</div>
            </div>`;
          } else {
            calendarHTML += `<div class="h-8 p-1">
              <div class="h-full flex items-center justify-center rounded-full hover:bg-gray-100 cursor-pointer date-btn text-sm text-gray-700" data-date="${year}-${String(month+1).padStart(2, '0')}-${String(day).padStart(2, '0')}">${day}</div>
            </div>`;
          }
        }

        calendarHTML += '</div>';

        if (calendarEl) {
          calendarEl.innerHTML = calendarHTML;

          // Navigation event listeners
          document.getElementById('prevMonth')?.addEventListener('click', () => {
            if (month === 0) {
              month = 11;
              year--;
            } else {
              month--;
            }
            renderCalendar(month, year);
          });

          document.getElementById('nextMonth')?.addEventListener('click', () => {
            if (month === 11) {
              month = 0;
              year++;
            } else {
              month++;
            }
            renderCalendar(month, year);
          });

          // Date selection event listeners
          document.querySelectorAll('.date-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              document.querySelectorAll('.date-btn').forEach(b => {
                b.classList.remove('bg-[#7dd3c0]', 'text-white');
                b.classList.add('hover:bg-gray-100');
              });

              const target = e.target;
              target.classList.add('bg-[#7dd3c0]', 'text-white');
              target.classList.remove('hover:bg-gray-100');

              const dateStr = target.getAttribute('data-date');
              if (dateStr) {
                selectDate(dateStr);
              }
            });
          });
        }
      }

      // Select a date and load available time slots
      async function selectDate(dateStr) {
        selectedDate = dateStr;

        // Remove pulse animation once date is selected
        calendarEl?.classList.remove('calendar-pulse');

        if (selectedDateEl) {
          const [year, month, day] = dateStr.split('-');
          const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
          const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
          const formattedDate = date.toLocaleDateString('en-US', options);
          selectedDateEl.textContent = formattedDate;
        }

        await loadAvailableTimeSlots(dateStr);
      }

      // Load available time slots from backend API
      async function loadAvailableTimeSlots(dateStr) {
        if (!timeSlotsEl || !loadingEl) return;

        // Show loading
        loadingEl.classList.remove('hidden');
        timeSlotsEl.innerHTML = '';

        try {
          // Fetch availability from our backend API
          const response = await fetch(`/api/availability?date=${dateStr}`);
          const data = await response.json();

          const availableSlots = data.availableSlots || [];

          // Hide loading
          loadingEl.classList.add('hidden');

          if (availableSlots.length > 0) {
            let slotsHTML = '';
            availableSlots.forEach((slot) => {
              const baseClasses = "p-3 rounded-md text-center text-sm cursor-pointer transition-colors time-btn";
              const stateClasses = "border border-gray-200 hover:bg-gray-50 text-gray-700";
              const localDisplayTime = formatLocalTimeRange(slot.startTime, slot.endTime) || slot.displayTime;
              const encodedDisplay = encodeURIComponent(localDisplayTime);

              slotsHTML += `
                <div class="${baseClasses} ${stateClasses}" data-time="${slot.startTime}-${slot.endTime}" data-start="${slot.startTime}" data-end="${slot.endTime}" data-display="${encodedDisplay}">
                  ${localDisplayTime}
                </div>
              `;
            });
            timeSlotsEl.innerHTML = slotsHTML;

            // Add time slot selection listeners
            document.querySelectorAll('.time-btn').forEach(btn => {
              btn.addEventListener('click', (event) => {
                document.querySelectorAll('.time-btn').forEach(button => {
                  button.classList.remove('bg-[#7dd3c0]', 'text-white');
                  button.classList.add('border', 'border-gray-200', 'hover:bg-gray-50', 'text-gray-700');
                });

                const buttonEl = event.currentTarget;
                buttonEl.classList.add('bg-[#7dd3c0]', 'text-white');
                buttonEl.classList.remove('border', 'border-gray-200', 'hover:bg-gray-50', 'text-gray-700');

                const displayAttr = buttonEl.getAttribute('data-display');
                const displayText = displayAttr ? decodeURIComponent(displayAttr) : (buttonEl.textContent || '').trim();

                selectedTimeSlot = {
                  date: selectedDate,
                  startTime: buttonEl.getAttribute('data-start'),
                  endTime: buttonEl.getAttribute('data-end'),
                  displayTime: displayText
                };

                // Update button text and show form
                if (confirmBookingEl) confirmBookingEl.textContent = 'Book This Class';
                studentForm?.classList.remove('hidden');

                // Minimize time slots - show only selected slot
                if (timeSlotsEl) {
                  timeSlotsEl.innerHTML = `
                    <div class="p-3 bg-[#7dd3c0] text-white rounded-md text-center text-sm font-semibold flex items-center justify-between">
                      <span>Selected: ${displayText}</span>
                      <button class="change-time-btn bg-white text-[#7dd3c0] hover:bg-gray-100 px-3 py-1.5 rounded-md text-sm font-bold ml-2 transition-colors shadow-sm">
                        Change Time
                      </button>
                    </div>
                  `;

                  // Add event listener to change time button
                  document.querySelector('.change-time-btn')?.addEventListener('click', () => {
                    loadAvailableTimeSlots(selectedDate || '');
                    selectedTimeSlot = null;
                    if (confirmBookingEl) confirmBookingEl.textContent = 'Select a time slot';
                    studentForm?.classList.add('hidden');
                  });
                }
              });
            });
          } else {
            timeSlotsEl.innerHTML = '<div class="text-center p-4 border border-gray-200 rounded-md text-gray-400">No available times for this date</div>';
          }
        } catch (error) {
          console.error('Error loading time slots:', error);
          loadingEl.classList.add('hidden');
          timeSlotsEl.innerHTML = '<div class="text-center p-4 border border-red-200 rounded-md text-red-400">Error loading availability. Please try again.</div>';
        }
      }

      // Handle booking confirmation
      async function handleBookingConfirmation() {
        if (!selectedTimeSlot) return;

        const studentName = document.getElementById('studentName')?.value;
        const studentEmail = document.getElementById('studentEmail')?.value;
        const spanishLevel = document.getElementById('spanishLevel')?.value;
        const lessonType = document.querySelector('input[name="lessonType"]:checked')?.value || 'individual';
        const courseType = 'conversational';

        // Validate all required fields
        if (!studentName || !studentEmail) {
          alert('Please fill in all required fields');
          return;
        }

        // Validate email format
        if (!validateEmail()) {
          return;
        }

        // Validate captcha
        if (!validateCaptcha()) {
          return;
        }

        try {
          // Show loading state
          if (confirmBookingEl) confirmBookingEl.textContent = 'Creating booking...';

          const recaptchaResponse = window.grecaptcha?.getResponse();

          // Send booking request to our backend API
          const timezoneInfo = Intl.DateTimeFormat().resolvedOptions();
          const studentTimeZone = timezoneInfo?.timeZone || 'UTC';

          const response = await fetch('/api/book-class', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              date: selectedDate,
              startTime: selectedTimeSlot.startTime,
              endTime: selectedTimeSlot.endTime,
              studentName,
              studentEmail,
              spanishLevel,
              lessonType,
              courseType,
              studentTimeZone,
              'g-recaptcha-response': recaptchaResponse
            })
          });

          const result = await response.json();

          if (response.ok) {
            showSuccessModal({
              date: selectedDate,
              displayTime: selectedTimeSlot.displayTime,
              studentName: studentName
            });
          } else {
            throw new Error(result.message || 'Booking failed');
          }

        } catch (error) {
          console.error('Booking error:', error);
          alert(error.message || 'There was an error creating your booking. Please try again or contact us directly.');
          if (confirmBookingEl) confirmBookingEl.textContent = 'Book This Class';
        }
      }

      // Reset booking form
      function resetBookingForm() {
        selectedTimeSlot = null;
        selectedDate = null;
        if (confirmBookingEl) confirmBookingEl.textContent = 'Select a time slot';
        studentForm?.classList.add('hidden');

        // Clear form fields
        ['studentName', 'studentEmail'].forEach(id => {
          const element = document.getElementById(id);
          if (element) element.value = '';
        });

        // Reset reCAPTCHA
        if (window.grecaptcha) {
          window.grecaptcha.reset();
        }

        // Clear validation errors
        document.getElementById('emailError')?.classList.add('hidden');
        document.getElementById('captchaError')?.classList.add('hidden');

        // Reset calendar selection
        document.querySelectorAll('.date-btn').forEach(b => {
          b.classList.remove('bg-[#7dd3c0]', 'text-white');
        });

        // Reset time slots
        if (timeSlotsEl) timeSlotsEl.innerHTML = '<div class="p-3 border border-gray-200 rounded-md text-center text-gray-400 text-sm">Select a date to see available times</div>';
        if (selectedDateEl) selectedDateEl.textContent = 'Please select a date from the calendar';
      }

      // Initialize calendar
      renderCalendar(currentMonth, currentYear);
    });
  </script>

  <style is:inline>
    .calendar-container {
      user-select: none;
    }

    @keyframes pulse-glow {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(125, 211, 192, 0.4);
      }
      50% {
        transform: scale(1.02);
        box-shadow: 0 0 20px 10px rgba(125, 211, 192, 0.2);
      }
    }

    .calendar-pulse {
      animation: pulse-glow 2s ease-in-out 3;
      border-radius: 0.5rem;
    }
  </style>
)}

{!classesAvailable && (
  <!-- ==================== WAITLIST SCRIPT ==================== -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('waitlistForm');
      const submitText = document.getElementById('waitlistSubmitText');

      // Email validation
      function validateEmail() {
        const emailInput = document.getElementById('waitlistEmail');
        const emailError = document.getElementById('waitlistEmailError');

        if (!emailInput || !emailError) return true;

        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (email && !emailRegex.test(email)) {
          emailError.textContent = 'Please enter a valid email address';
          emailError.classList.remove('hidden');
          emailInput.classList.add('border-red-300');
          return false;
        } else {
          emailError.classList.add('hidden');
          emailInput.classList.remove('border-red-300');
          return true;
        }
      }

      // Validate reCAPTCHA
      function validateCaptcha() {
        const captchaError = document.getElementById('waitlistCaptchaError');

        if (!captchaError) return false;

        const recaptchaResponse = window.grecaptcha?.getResponse();

        if (!recaptchaResponse || recaptchaResponse.length === 0) {
          captchaError.textContent = 'Please complete the reCAPTCHA verification.';
          captchaError.classList.remove('hidden');
          return false;
        } else {
          captchaError.classList.add('hidden');
          return true;
        }
      }

      // Show success modal
      function showSuccessModal(data) {
        const modal = document.getElementById('waitlistSuccessModal');
        const modalName = document.getElementById('waitlistModalName');
        const modalEmail = document.getElementById('waitlistModalEmail');
        const modalLevel = document.getElementById('waitlistModalLevel');

        if (modal && modalName && modalEmail && modalLevel) {
          modalName.textContent = `ðŸ‘¤ ${data.name}`;
          modalEmail.textContent = `ðŸ“§ ${data.email}`;
          modalLevel.textContent = `ðŸ“š Level: ${data.level.charAt(0).toUpperCase() + data.level.slice(1)}`;

          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
      }

      // Close modal
      function closeModal() {
        const modal = document.getElementById('waitlistSuccessModal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto';

          // Reset form
          form.reset();
          if (window.grecaptcha) {
            window.grecaptcha.reset();
          }

          // Redirect to home after a short delay
          setTimeout(() => {
            window.location.href = '/';
          }, 300);
        }
      }

      // Form submission
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Validate email
        if (!validateEmail()) return;

        // Validate captcha
        if (!validateCaptcha()) return;

        const studentName = document.getElementById('waitlistName')?.value.trim();
        const studentEmail = document.getElementById('waitlistEmail')?.value.trim();
        const spanishLevel = document.getElementById('waitlistLevel')?.value;
        const message = document.getElementById('waitlistMessage')?.value.trim();
        const recaptchaResponse = window.grecaptcha?.getResponse();

        // Show loading state
        if (submitText) submitText.textContent = 'Joining waitlist...';

        try {
          const response = await fetch('/api/waitlist', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              name: studentName,
              email: studentEmail,
              spanishLevel,
              message,
              'g-recaptcha-response': recaptchaResponse
            })
          });

          const result = await response.json();

          if (response.ok) {
            showSuccessModal({
              name: studentName,
              email: studentEmail,
              level: spanishLevel
            });
          } else {
            throw new Error(result.message || 'Failed to join waitlist');
          }
        } catch (error) {
          console.error('Waitlist error:', error);
          alert(error.message || 'There was an error. Please try again.');
          if (submitText) submitText.textContent = 'Join the Waitlist';
        }
      });

      // Email blur validation
      document.getElementById('waitlistEmail')?.addEventListener('blur', validateEmail);

      // Modal close handlers
      document.getElementById('closeWaitlistModal')?.addEventListener('click', closeModal);
      document.getElementById('waitlistSuccessModal')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          closeModal();
        }
      });
    });
  </script>
)}
