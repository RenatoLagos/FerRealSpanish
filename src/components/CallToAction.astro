---
import Button from './ui/button.astro';

// Clave de sitio de reCAPTCHA desde variables de entorno
const siteKey = import.meta.env.RECAPTCHA_SITE_KEY || "6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"; // Fallback a clave de prueba
---

<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<section id="contact-section" class="py-20 bg-[var(--background-secondary)]">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex flex-col md:flex-row gap-12 items-center">
      <!-- Contenido a la izquierda -->
      <div class="md:w-3/5 text-left flex flex-col gap-8">
        <div class="space-y-6">
          <h2 class="text-white text-5xl font-satoshi font-extrabold">Let's Talk!</h2>
          
          <p class="text-white text-lg font-satoshi max-w-lg">
            Curious if this is right for you? Schedule a free, no-pressure consultation and discover how our Spanish program can help you achieve your language goals.
          </p>
        </div>
        
        <div>
          <Button 
            variant="primary" 
            size="lg" 
            rounded={true}
            shadow={true}
            href="/schedule-class"
          >
            Book your first class - It's FREE!
          </Button>
        </div>
      </div>
      
      <!-- Formulario de contacto desplegable -->
      <div class="md:w-2/5 w-full">
        <h3 class="text-white text-lg font-satoshi mb-3 px-1">Or if you prefer, you can send us a message:</h3>
        <div class="bg-[var(--background-secondary)] rounded-lg overflow-hidden border border-[var(--accent)] shadow-lg">
          <button 
            id="toggleForm" 
            class="w-full flex items-center justify-between text-white font-satoshi font-bold text-xl py-4 px-6 bg-[var(--accent)] hover:bg-[var(--accent-dark)] transition-colors duration-300"
          >
            <span class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
              </svg>
              Contact Form
            </span>
            <svg id="formArrow" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 transform transition-transform duration-300">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
          </button>
          
          <div id="contactForm" class="hidden p-6">
            <form id="contactFormSubmit" class="space-y-4">
              <div class="mb-4">
                <label for="firstName" class="block text-white font-satoshi mb-2">First Name</label>
                <input
                  type="text"
                  id="firstName"
                  name="firstName"
                  autocomplete="given-name"
                  placeholder="Enter your first name"
                  class="w-full px-4 py-2 bg-[var(--background-primary)] border border-[var(--border)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--accent)] text-gray-900 placeholder-gray-400"
                />
              </div>
              
              <div class="mb-4">
                <label for="lastName" class="block text-white font-satoshi mb-2">Last Name</label>
                <input
                  type="text"
                  id="lastName"
                  name="lastName"
                  autocomplete="family-name"
                  placeholder="Enter your last name"
                  class="w-full px-4 py-2 bg-[var(--background-primary)] border border-[var(--border)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--accent)] text-gray-900 placeholder-gray-400"
                />
              </div>
              
              <div class="mb-4">
                <label for="email" class="block text-white font-satoshi mb-2">Email</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  autocomplete="email"
                  placeholder="Enter your email"
                  class="w-full px-4 py-2 bg-[var(--background-primary)] border border-[var(--border)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--accent)] text-gray-900 placeholder-gray-400"
                />
              </div>
              
              <div class="mb-6">
                <label for="message" class="block text-white font-satoshi mb-2">Your Message</label>
                <textarea
                  id="message"
                  name="message"
                  rows="4"
                  placeholder="Enter your message"
                  class="w-full px-4 py-2 bg-[var(--background-primary)] border border-[var(--border)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--accent)] text-gray-900 placeholder-gray-400"
                ></textarea>
              </div>
              
              <!-- reCAPTCHA -->
              <div class="mb-4">
                <label class="block text-white font-satoshi mb-2">Human Verification</label>
                <div class="g-recaptcha" data-sitekey={siteKey}></div>
                <div id="captchaError" class="hidden text-red-500 text-xs mt-1"></div>
              </div>
              
              <!-- Área de mensajes -->
              <div id="formMessage" class="hidden mb-4 p-4 rounded-md"></div>
              
              <button
                type="submit"
                id="submitButton"
                class="w-full bg-[var(--accent)] hover:bg-[var(--accent-dark)] text-white font-satoshi font-bold py-3 px-6 rounded-lg transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span id="submitText">Submit</span>
                <span id="submitLoader" class="hidden">
                  <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Sending...
                </span>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Declare reCAPTCHA interface
  declare global {
    interface Window {
      grecaptcha: {
        getResponse(): string;
        reset(): void;
      };
    }
  }

  // Script para controlar la visibilidad del formulario y manejar el envío
  document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('toggleForm');
    const formContainer = document.getElementById('contactForm');
    const arrow = document.getElementById('formArrow');
    const contactForm = document.getElementById('contactFormSubmit') as HTMLFormElement;
    const submitButton = document.getElementById('submitButton') as HTMLButtonElement;
    const submitText = document.getElementById('submitText');
    const submitLoader = document.getElementById('submitLoader');
    const formMessage = document.getElementById('formMessage');
    
    // Controlar visibilidad del formulario
    if (toggleBtn && formContainer && arrow) {
      toggleBtn.addEventListener('click', () => {
        formContainer.classList.toggle('hidden');
        arrow.classList.toggle('rotate-180');
      });
    }
    
    // Función para mostrar mensajes
    function showMessage(message: string, isError: boolean = false) {
      if (formMessage) {
        formMessage.textContent = message;
        formMessage.className = `mb-4 p-4 rounded-md ${isError ? 'bg-red-100 border border-red-400 text-red-700' : 'bg-green-100 border border-green-400 text-green-700'}`;
        formMessage.classList.remove('hidden');
        
        // Auto-hide después de 5 segundos si es éxito
        if (!isError) {
          setTimeout(() => {
            formMessage.classList.add('hidden');
          }, 5000);
        }
      }
    }
    
    // Función para mostrar/ocultar loader
    function setLoading(loading: boolean) {
      if (submitButton && submitText && submitLoader) {
        submitButton.disabled = loading;
        if (loading) {
          submitText.classList.add('hidden');
          submitLoader.classList.remove('hidden');
        } else {
          submitText.classList.remove('hidden');
          submitLoader.classList.add('hidden');
        }
      }
    }
    
    // Función para validar reCAPTCHA
    function validateCaptcha() {
      const captchaError = document.getElementById('captchaError');
      
      if (!captchaError) return false;
      
      // Obtener respuesta de reCAPTCHA
      const recaptchaResponse = window.grecaptcha?.getResponse();
      
      if (!recaptchaResponse || recaptchaResponse.length === 0) {
        captchaError.textContent = 'Please complete the reCAPTCHA verification.';
        captchaError.classList.remove('hidden');
        return false;
      } else {
        captchaError.classList.add('hidden');
        return true;
      }
    }
    
    // Manejar envío del formulario
    if (contactForm) {
      contactForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Ocultar mensajes previos
        if (formMessage) {
          formMessage.classList.add('hidden');
        }
        
         // Obtener datos del formulario
         const formData = new FormData(contactForm);
         const data = {
           firstName: formData.get('firstName'),
           lastName: formData.get('lastName'),
           email: formData.get('email'),
           message: formData.get('message')
         };
        
                 // Validar campos
         if (!data.firstName || !data.lastName || !data.email || !data.message) {
           showMessage('Please fill in all fields.', true);
           return;
         }
         
         // Validar reCAPTCHA
         if (!validateCaptcha()) {
           return;
         }
         
         // Obtener token de reCAPTCHA
         const recaptchaResponse = window.grecaptcha?.getResponse();
         
         // Mostrar loader
         setLoading(true);
        
                 try {
           const response = await fetch('/api/contact-form', {
             method: 'POST',
             headers: {
               'Content-Type': 'application/json',
             },
             body: JSON.stringify({
               ...data,
               'g-recaptcha-response': recaptchaResponse
             })
           });
          
          const result = await response.json();
          
                     if (response.ok && result.success) {
            showMessage(result.message || '¡Thank you! Your message has been sent successfully. We will respond soon.');
            contactForm.reset(); // Limpiar formulario
            
            // Reset reCAPTCHA
            if (window.grecaptcha) {
              window.grecaptcha.reset();
            }
            
            // Limpiar errores de validación
            document.getElementById('captchaError')?.classList.add('hidden');
          } else {
            showMessage(result.message || 'There was an error sending your message. Please try again.', true);
          }
          
        } catch (error) {
          console.error('Form submission error:', error);
          showMessage('There was an error sending your message. Please try again.', true);
          
          // Reset reCAPTCHA en caso de error
          if (window.grecaptcha) {
            window.grecaptcha.reset();
          }
        } finally {
          setLoading(false);
        }
      });
    }
  });
</script>
